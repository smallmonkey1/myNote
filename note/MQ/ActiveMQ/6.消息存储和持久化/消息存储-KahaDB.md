##### AMQ的持久化机制(了解)

AMQ是一种文件存储形式，具有快速写入和容易恢复的特点。消息存储在一个个文件中，文件默认大小为32M，当一个存储文件中的消息全部被消费，这个文件将被标识为**可删除**，在下一个清除阶段，这个文件被删除。AMQ适用于ActiveMQ5.3之前的版本。

##### KahaDB消息存储(默认)

基于日志文件，5.4开始默认的持久化插件。就跟redis的AOF一个意思吧？

##### 看看在5.15.x的版本KahaDB是否过时？

在`ActiveMQ`的安装目录下`conf`，查看`activemq.xml`

当前默认的消息存储是哪个？？--》kahaDB

![image-20200324211509665](E:\Desktop\note\MQ\ActiveMQ\消息存储.assets\image-20200324211509665.png)

可以看到 就是kahadb没错了

---

### 说明：

目前默认的存储方式，可用于任何场景，提高了性能和恢复能力

消息存储使用一个**事务日志**和仅用一个**索引文件**来存储他所在的地址。

KahaDB是一个专门针对消息持久化的解决方案，他对典型的消息使用模式进行了优化。

数据被追加到data logs中，当不再需要log文件中的数据时，log会被丢弃

![image-20200324213012911](E:\Desktop\note\MQ\ActiveMQ\消息存储.assets\image-20200324213012911.png)

---

### 存储原理：

Kahadb在消息保存目录中只有4类文件和一个lock，跟ActiveMQ的其他几种文件存储引擎相比，这就非常简洁了。如上

**`db-[int].log`：**kahadb存储消息到预定大小的**数据记录文件**中，文件名为`db-<number>.log`。当数据文件已满时，一个新的文件会随之创建，number数值也会随之递增，他随着消息数量的增多，如每32M一个文件，文件名按照数字进行编码，但**不在有引用**到数据文件中的**任何消息**时，文件会被**删除**或**归档**。

**db.data**：包含了持久化的BTree索引，就是个索引文件。索引了消息数据记录中(db-1.log)中的消息，本质是B-Tree，指向**数据记录文件**中存储的信息。

**db.free**：当前`db.data`文件里哪些页面是空闲的，文件具体内容是所有空闲页的ID。方便建索引的 时候首先从db.free文件**查找空闲**页，**减少碎片**。

**db.redo**：用来进行消息回复的，顾名思义redo-重启，如果kahaDB消息存储在强制退出后启动，用于回复BTree索引。是一种**容灾备份机制**

**lock**：就是一个锁。表示当前获取kahadb读写权限的broker

---

