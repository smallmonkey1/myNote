# 第一题

## spring.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:jdbc="http://www.springframework.org/schema/jdbc"
	xmlns:tx="http://www.springframework.org/schema/tx"
	xmlns:context="http://www.springframework.org/schema/context"
	xsi:schemaLocation="http://www.springframework.org/schema/jdbc http://www.springframework.org/schema/jdbc/spring-jdbc-4.3.xsd
		http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
		http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.3.xsd
		http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-4.3.xsd">
	
	<context:property-placeholder location="classpath:database.properties"/>
	<context:component-scan base-package="com.zfl"></context:component-scan>
	<bean id="dataSource" class="com.mchange.v2.c3p0.ComboPooledDataSource">
		<property name="user" value="${jdbc.username}"></property>
		<property name="password" value="${jdbc.password}"></property>
		<property name="jdbcUrl" value="${jdbc.url}"></property>
		<property name="driverClass" value="${jdbc.driver}"></property>
	</bean>
	
	<bean class="org.springframework.jdbc.core.JdbcTemplate">
		<constructor-arg name="dataSource" ref="dataSource"></constructor-arg>
	</bean>
	
	<bean class="org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate">
		<constructor-arg name="dataSource" ref="dataSource"></constructor-arg>
	</bean>
</beans>
```



## database.properties



```properties
jdbc.username=root
jdbc.password=123456
jdbc.url=jdbc:mysql://localhost:3306/spring?serverTimezone=UTC
jdbc.driver=com.mysql.cj.jdbc.Driver
```





## User.java

```java
package com.zfl.bean;
/*
@author author ZFL:
@version time:2020年5月21日下午3:15:48
*/
public class User {
	private Integer id;
	private String username;
	private String address;
	public User(Integer id, String username, String address) {
		this.id = id;
		this.username = username;
		this.address = address;
	}
	public User() {
	}
	public Integer getId() {
		return id;
	}
	public void setId(Integer id) {
		this.id = id;
	}
	public String getUsername() {
		return username;
	}
	public void setUsername(String username) {
		this.username = username;
	}
	public String getAddress() {
		return address;
	}
	public void setAddress(String address) {
		this.address = address;
	}
	@Override
	public String toString() {
		return "User [id=" + id + ", username=" + username + ", address=" + address + "]";
	}
	
}
```





## baseDao.java

```java
package com.zfl.dao;

/*
@author author ZFL:
@version time:2020年5月21日下午3:14:04
*/
public interface BaseDao <T>{
	void insert(T t);
	void deleteById(Integer id);
	void update(T t);
	T queryById(Integer id);
	List<T> queryAll();
	void batchInsert(List<T> list);
}
```



## UserDao.java

```java
package com.zfl.dao;

/*
@author author ZFL:
@version time:2020年5月21日下午3:13:44
*/
@Component
public class UserDao implements BaseDao<User> {

	@Autowired
	JdbcTemplate template;

	@Override
	public void insert(User t) {
		String sql = "insert into user(username,address) values(?,?);";
		int update = template.update(sql, t.getUsername(), t.getAddress());
		log(update);
	}

	private void log(int update) {
		if (update <= 0)
			System.out.println("update failure");
		else
			System.out.println("update successed!-->" + update + "row");
	}

	@Override
	public void deleteById(Integer id) {
		String sql = "delete from user where id=?";
		int update = template.update(sql, id);
		log(update);
	}

	@Override
	public void update(User t) {
		String sql = "update user set username=?,address=? where id=?;";
		int update = template.update(sql, t.getUsername(), t.getAddress(), t.getId());
		log(update);
	}

	@Override
	public User queryById(Integer id) {
		String sql = "select * from user where id=?";
		//User queryResult = template.queryForObject(sql, User.class, id);
		User user = template.queryForObject(sql, new BeanPropertyRowMapper<User>(User.class), id);
		return user;
	}

	@Override
	public List<User> queryAll() {
		String sql = "select * from user";
		List<User> list = template.query(sql, new BeanPropertyRowMapper<>(User.class));
		return list;
	}

	@Override
	public void batchInsert(List<User> list) {
		String sql = "insert into user(username,address) values(?,?);";
		List<Object[]> batchArgs = new ArrayList<Object[]>();
		for (User u : list) {
			batchArgs.add(new Object[] {u.getUsername(), u.getAddress()});
		}
		template.batchUpdate(sql, batchArgs);		
	}
}
```

## mainTest.java

```java
/*
@author author ZFL:
@version time:2020年5月21日下午3:25:33
*/
class mainTest {
	AbstractXmlApplicationContext ioc = null;

	@Test
	void insertTest() {
		ioc = new ClassPathXmlApplicationContext("spring.xml");
		UserDao bean = ioc.getBean(UserDao.class);
		User user = new User(null, "跳跳虎张三", "广西");
		bean.insert(user);
	}

	static List<User> list = null;
	static {
		list = new ArrayList<>();
		list.add(new User(null, "李四2", "湖北"));
		list.add(new User(null, "Tommy3", "Greek"));
		list.add(new User(null, "Jerry4", "Britsh"));
		list.add(new User(null, "joen5", "Peris"));
	}

	@Test
	void batchInsertTest() {
		ioc = new ClassPathXmlApplicationContext("spring.xml");
		UserDao bean = ioc.getBean(UserDao.class);
		bean.batchInsert(list);
	}

	@Test
	void queryAllTest() {
		ioc = new ClassPathXmlApplicationContext("spring.xml");
		UserDao bean = ioc.getBean(UserDao.class);
		List<User> list2 = bean.queryAll();
		for (User u : list2) {
			System.out.println(u);
		}
	}
	
	@Test
	void queryByIdTest() {
		ioc = new ClassPathXmlApplicationContext("spring.xml");
		UserDao bean = ioc.getBean(UserDao.class);
		System.out.println(bean.queryById(3));
	}
	
	@Test
	void upadteTest() {
		ioc = new ClassPathXmlApplicationContext("spring.xml");
		UserDao bean = ioc.getBean(UserDao.class);
		
		bean.update(new User(2, "updatePeople", "WuHan"));
	}
	
	@Test
	void deleteTest() {
		ioc = new ClassPathXmlApplicationContext("spring.xml");
		UserDao bean = ioc.getBean(UserDao.class);
		bean.deleteById(2);
	}

}
```



# 第二题

## spring.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:mybatis-spring="http://mybatis.org/schema/mybatis-spring"
       xmlns:aop="http://www.springframework.org/schema/aop" xmlns:tx="http://www.springframework.org/schema/tx"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/tool http://www.springframework.org/schema/tool/spring-tool.xsd http://mybatis.org/schema/mybatis-spring http://mybatis.org/schema/mybatis-spring.xsd http://www.springframework.org/schema/aop https://www.springframework.org/schema/aop/spring-aop.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd">

    <context:component-scan base-package="com.zfl"/>
    <context:property-placeholder location="classpath:dbconfig.properties"/>


    <bean id="ds" class="com.mchange.v2.c3p0.ComboPooledDataSource">
        <property name="user" value="${jdbc.user}"></property>
        <property name="password" value="${jdbc.password}"></property>
        <property name="driverClass" value="${jdbc.driverClass}"></property>
        <property name="jdbcUrl" value="${jdbc.jdbcUrl}"></property>

        <property name="maxPoolSize" value="${jdbc.maxPoolSize}"></property>
        <property name="minPoolSize" value="${jdbc.minPoolSize}"></property>
    </bean>

    <bean id="tm" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
        <property name="dataSource" ref="ds"></property>
    </bean>


    <tx:annotation-driven transaction-manager="tm"/>

    <aop:config>
        <aop:pointcut expression="execution(* com.zfl.service.*.*(..))" id="txPoint"/>
        <aop:advisor advice-ref="myTx" pointcut-ref="txPoint"/>
    </aop:config>
    <tx:advice id="myTx" transaction-manager="tm">
        <tx:attributes>
            <tx:method name="*" rollback-for="java.lang.Exception"/>
            <tx:method name="query*" read-only="true"/>
        </tx:attributes>
    </tx:advice>

    <bean class="org.mybatis.spring.SqlSessionFactoryBean">
        <property name="configLocation" value="classpath:mybatis/mybatis-config.xml"></property>
        <property name="dataSource" ref="ds"></property>
        <property name="mapperLocations" value="classpath:mybatis/mapper/*.xml"></property>
    </bean>

    <mybatis-spring:scan base-package="com.zfl.dao"/>
</beans>
```



## mybatis-config.xml

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>


</configuration>
```

## personMapper.xml

```xml
<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zfl.dao.PersonDao">
    <insert id="insert">
        insert into person(name,age,sex,card_id)
        values(#{name},#{age},#{sex},#{card_id});
    </insert>
    <update id="update">
        update person
        set name=#{name},age=#{age},sex=#{sex},card_id=#{card_id}
        where id=#{id}
    </update>
    <delete id="deleteById">
        delete from person where id=#{id}
    </delete>

    <select id="queryById" resultType="com.zfl.entity.Person">
        select * from person where id = #{id}
    </select>
    <select id="queryAll" resultType="com.zfl.entity.Person">
        select * from person
    </select>
</mapper>
```





## dbconfig.properties

```properties
jdbc.user=root
jdbc.password=123456
jdbc.jdbcUrl=jdbc:mysql://localhost:3306/spring?serverTimezone=UTC&useSSL=false
jdbc.driverClass=com.mysql.cj.jdbc.Driver
```





## PersonDao.java

```java
package com.zfl.dao;

import com.zfl.entity.Person;

import java.util.List;

/**
 * project--SpringMyBatisDemo.
 * Create by zfl on 2020/5/21 21:21.
 **/
public interface PersonDao {
    public Person queryById(Integer id);
    public void insert(Person person);
    void deleteById(Integer id);
    void update(Person person);
    List<Person> queryAll();
}
```



## PersonService.java

```java
package com.zfl.service;

import com.zfl.dao.PersonDao;
import com.zfl.entity.Person;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

/**
 * project--SpringMyBatisDemo.
 * Create by zfl on 2020/5/21 21:21.
 **/
@Service
public class PersonService {

    @Autowired
    private PersonDao personDao;
    public Person queryById(Integer id){
        return personDao.queryById(id);
    }

    public void insert(Person person) {
        personDao.insert(person);
        System.out.println("successed!");
    }

    public void deleteById(Integer id) {
        personDao.deleteById(id);
    }

    public void update(Person person) {
        personDao.update(person);
    }

    public List<Person> queryAll() {
        return personDao.queryAll();
    }

}
```





## PeresonServiceTest.java

```java
package com.zfl.service;

import com.zfl.entity.Person;
import org.junit.BeforeClass;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.Test;
import org.springframework.context.support.AbstractApplicationContext;
import org.springframework.context.support.ClassPathXmlApplicationContext;

import java.util.List;
import java.util.Random;

import static org.junit.jupiter.api.Assertions.*;

/**
 * project--SpringMyBatisDemo.
 * Create by zfl on 2020/5/21 21:59.
 **/
class PersonServiceTest {

    AbstractApplicationContext ioc = null;
    PersonService service = null;


    @Test
    void queryById() {
        ioc = new ClassPathXmlApplicationContext("spring/spring.xml");
        service = ioc.getBean(PersonService.class);
        System.out.println(service.queryById(12));
    }

    @Test
    void insert() {
        ioc = new ClassPathXmlApplicationContext("spring/spring.xml");
        service = ioc.getBean(PersonService.class);
        //int i = 12;
        for(int i = 0; i <2; i++) {
            Person person = new Person(null,("xjt"+i),new Random().nextInt((i+1)), (i%2==0?"男":"女"),1223+i);
            service.insert(person);
        }
    }

    @Test
    void deleteById() {
        ioc = new ClassPathXmlApplicationContext("spring/spring.xml");
        service = ioc.getBean(PersonService.class);
        service.deleteById(11);
    }

    @Test
    void update() {
        ioc = new ClassPathXmlApplicationContext("spring/spring.xml");
        service = ioc.getBean(PersonService.class);
        service.update(new Person(1,"修改了你的名字", 12, "修改你性别", 122034));
    }

    @Test
    void queryAll() {
        ioc = new ClassPathXmlApplicationContext("spring/spring.xml");
        service = ioc.getBean(PersonService.class);
        List<Person> people = service.queryAll();
        for (Person person : people) {
            System.out.println(person);
        }
    }
}
```

